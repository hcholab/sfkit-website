{% extends 'base.html' %}

{% block title %}Workflow{% endblock %}

{% block content %}
  <section class="py-5">
    <div class="container">
      <div class="row">
        <div class="col-12 col-lg-9 mx-auto">
          <h1 class="h1 fw-bold mb-5 text-center">Workflow Instructions</h2>
          <p class="text-muted">This page details the instructions for how to use this portal to securely run GWAS:</p>
          <div class="accordion" id="workflow">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-1">
                  1. Join Project
                </button>
              </h2>
              <div class="accordion-collapse collapse collapse-1 collapse-1-2">
                <div class="accordion-body">
                  <p>
                    Go to the
                    <a class="text-decoration-none" href="{{ url_for('gwas.index') }}">Projects</a>
                    page and either create a new project or join an existing project.
                  </p>
                  <p class="text-muted">
                    Note: You will need to provide the name of a google-cloud project where you will be uploading your encrypted data. When the protocol eventually begins, the portal will create a VM (virtual machine) in this GCP (google-cloud platform) project to run your share of the GWAS.
                  </p>
                  <p class="text-muted">
                    Note: If you are creating a new project, you will also need to upload study paramters. If you are joining a project, you should confirm that the configured study parameters are what you want.
                  </p>
                  <p class="text-end mb-0 mt-0">
                    <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-1-2">
                      Next
                    </button>
                  </p>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-2">
                  2. Generate Keys
                </button>
              </h2>
              <div class="accordion-collapse collapse collapse-2 collapse-1-2 collapse-2-3">
                <div class="accordion-body">
                  <p>
                    1. On your computer, clone the
                    <a class="text-decoration-none" href="https://github.com/simonjmendelsohn/secure-gwas-keys-and-encryption">Secure GWAS Cryptographic Keys and Encryption</a>
                    repository (with
                    <code>git clone https://github.com/simonjmendelsohn/secure-gwas-keys-and-encryption.git</code>).
                  </p>
                  <p>
                    2. Install the dependencies for the repo with
                    <code>pip install -r requirements.txt</code>.
                  </p>
                  <p>
                    3. run
                    <code>python3 generate_personal_keys.py</code>
                    to generate your personal keys. Keep the private key somewhere safe, and upload the public key to your project on this website.
                  </p>
                  <p class="text-end mb-0 mt-0">
                    <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-2-3">
                      Next
                    </button>
                  </p>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-3">
                  3. Encrypt Data
                </button>
              </h2>
              <div class="accordion-collapse collapse collapse-3 collapse-2-3 collapse-3-4">
                <div class="accordion-body">
                  <p>
                    1. Copy down the other study participant's public key from the project page.
                    <strong>Note: you cannot proceed without this key.</strong>
                  </p>
                  <p>
                    2. Go back into the Secure GWAS Cryptographic Keys and Encryption repository on your local computer (you should have used it to generate keys in the previous step), and replace the contents of the "input_data" directory with your actual raw data.
                  </p>
                  <p>
                    3. Run
                    <code>python3 encrypt_data.py</code>
                    to encrypt your data.
                  </p>
                  <p>
                    4. Upload the encrypted data to a google cloud storage bucket in your GCP project. If you are unfamiliar with Google Cloud Storage, see the google documentation
                    <a class="text-decoration-none" href="https://cloud.google.com/storage/docs/quickstart-console">here</a>. The default settings should be fine.
                  </p>
                  <p class="text-end mb-0 mt-0">
                    <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-3-4">
                      Next
                    </button>
                  </p>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-4">
                  4. Give Permissions
                </button>
              </h2>
              <div class="accordion-collapse collapse collapse-4 collapse-3-4 collapse-4-5">
                <div class="accordion-body">
                  <p>
                    Go to the
                    <a class="text-decoration-none" href="{{ url_for('general.permissions') }}">Permissions</a>
                    page and follow the instructions there to give this website the correct permissions to your GCP project.
                  </p>
                  <p class="text-end mb-0 mt-0">
                    <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-4-5">
                      Next
                    </button>
                  </p>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-5">
                  5. Begin Workflow
                </button>
              </h2>
              <div class="accordion-collapse collapse collapse-5 collapse-4-5 collapse-5-6">
                <div class="accordion-body">
                  <p>
                    Go to your project, and click on the "Ready to begin GWAS?" button. Once you all participants have done so, the protocol will begin.
                  </p>
                  <p class="text-end mb-0 mt-0">
                    <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-5-6">
                      Next
                    </button>
                  </p>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-6">
                  6. Enjoy the Results
                </button>
              </h2>
              <div class="accordion-collapse collapse collapse-6 collapse-5-6">
                <div class="accordion-body">
                  <p>
                    Once the protocol is complete, the project page will indicate this with a "GWAS Completed!" status. You can then download the results to share and analyze at your leisure.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}
