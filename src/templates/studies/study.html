{% extends 'base.html' %}
{% block title %}Study Start?{% endblock %}
{% block content %}
  <meta id="study-title-data" data-value="{{ study['title'] }}">
  <meta id="id-data" data-value="{{ g.user['id'] }}">
  <meta id="num-cpus-data" data-value="{{ request.form['NUM_CPUS'] or parameters['NUM_CPUS']['value'] }}">

  <section class="py-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-7 mx-auto">
          <div class="p-5 bg-light rounded text-center">
            <span>
              <small class="text-muted">
                Created by
                {{ study['owner'] }}
                on
                {{ study['created'].strftime('%m-%d-%Y') }}
              </small>
            </span>
            <h2 class="mt-2 fw-bold">{{ study['title'] }}</h2>
            <p class="lead text-muted mb-1">{{ study['description'] }}</p>
            <div class="mb-2">
              {% include 'studies/utils/study_information.html'%}
            </div>
            <div class="mb-3">
              <div>
                <p class="fw-bold mb-0">Study Participants:</p>
                {% for i in range(study['participants'] | length) %}
                  {{study['participants'][i]}}
                  <br>
                {% endfor %}
              </div>
            </div>
            {% if study['requested_participants'] %}
              <div class=" mb-3">
                Requested Participants:
                {% for participant in study['requested_participants'] %}
                  <br>
                  <small class="text-muted ms-2 me-2">
                    {{ participant }}
                    <a href="{{ url_for('studies.approve_join_study', study_title=study['title'], user_id=participant) }}" type="button" class="btn btn-sm btn-info">Approve Request</a>
                  </small>
                {% endfor %}
              </div>
            {% endif %}
            <div class="mb-3" id="instructions">
              {% if parameters['CONFIGURE_STUDY_GCP_SETUP_MODE']['value'] == "" %}
                <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#configure_study_gcp_setup_mode_modal">Configure Study</button>
                {% include 'studies/utils/configure_study_gcp_setup_mode.html' %}
              {% elif parameters['CONFIGURE_STUDY_GCP_SETUP_MODE']['value'] == "website" %}
                <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#configure_study_modal">Configure Study</button>

                <div class="modal fade" id="configure_study_modal" tabindex="-1">
                  <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="configure_study_modal_label">Configure your
                          {{ type }}
                          Study</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        {% include 'studies/utils/instructions.html' %}
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
              {% else %}
                <h5>Please proceed with the CLI tool with
                  <i>`pip install sfkit`</i>. For more details, see the coresponding github repo
                  <a class="text-decoration-none" href="https://github.com/simonjmendelsohn/sfkit">here</a>.</h5>
              {% endif %}
            </div>
            {% if parameters['CONFIGURE_STUDY_GCP_SETUP_MODE']['value'] == "user" %}
            {% elif study["status"][g.user["id"]] == [""] or study["status"][g.user["id"]] == ["validating"] %}
              <button type="button" class="mt-2 btn btn-success" data-bs-toggle="modal" data-bs-target="#vmConfig" disabled="disabled">
                Begin
                {{ type }}
                Workflow
              </button>
              <p>You must finish configuring your study before you can begin the
                {{ type }}
                workflow</p>
            {% elif study["status"][g.user["id"]] == ["not ready"] %}
              <button type="button" class="mt-2 btn btn-success" data-bs-toggle="modal" data-bs-target="#vmConfig">
                Begin
                {{ type }}
                Workflow
              </button>
              <div class="modal fade" id="vmConfig" tabindex="-1">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="vmConfigLabel">Choose Virtual Machine Configuration</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body container">
                      <form action="{{ url_for(type.lower() + '.start_protocol', study_title=study['title']) }}" method="post">
                        <div class="text-start row">
                          <label for="BOOT_DISK_SIZE" class="col-sm-3 col-form-label">{{parameters['BOOT_DISK_SIZE']['name']}}</label>
                          <div class="col-sm-9">
                            <input type="number" class="form-control" id="BOOT_DISK_SIZE" name="BOOT_DISK_SIZE" min="10" value="{{request.form['BOOT_DISK_SIZE'] or parameters['BOOT_DISK_SIZE']['value']}}">
                          </div>
                        </div>
                        <p class="mt-3 text-start text-muted">
                          {{parameters['BOOT_DISK_SIZE']['description']}}
                        </p>
                        <div class="text-start row">
                          <label for="NUM_CPUS" class="col-sm-3 col-form-label">
                            {{parameters['NUM_CPUS']['name']}}
                          </label>
                          <div class="col-sm-9">
                            <select class="form-select" name="NUM_CPUS" id="NUM_CPUS" value="{{ request.form['NUM_CPUS'] or parameters['NUM_CPUS']['value'] }}">
                              <option value="4">4</option>
                              <option value="8">8</option>
                              <option value="16">16</option>
                            </select>
                          </div>
                        </div>
                        <p class="mt-3 text-start text-muted">
                          {{parameters['NUM_CPUS']['description']}}
                        </p>
                        <button class="mt-2 btn btn-primary" type="submit" onclick="loading();">
                          <div class="loading" style="display:none">
                            <span class="spinner-grow spinner-grow-sm" role="status"></span>
                            Loading...
                          </div>
                          <div class="normal-content">
                            Confirm Virtual Machine Configuration
                          </div>
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            {% else %}
              <br>
              Status:
              {% if ((["not ready"] in study["status"].values())or([""] in study["status"].values())or(["invalid data"] in study["status"].values())or(["validating"] in study["status"].values())) %}
                Waiting for others to be ready...
              {% else %}
                <div class="status text-start"></div>
              {% endif %}
              <br>
              <form action="{{ url_for(type.lower() + '.start_protocol', study_title=study['title']) }}" method="post">
                <button type="submit" class="btn btn-secondary">Check for update</button>
              </form>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block javascript %}
  <script>
    function loading() {
      $(".loading").show();
      $(".normal-content").hide();
    }
  </script>

  <script>
    $(document).ready(function () {
      $('#NUM_CPUS').val($('#num-cpus-data').data()['value']);
    });
  </script>

  <script type="module">
    // get the status updates from firestore
    import {getStatusUpdates} from "/static/javascript/firestore.js";

    var study_title = document
      .getElementById("study-title-data")
      .attributes["data-value"]
      .value
      .toLowerCase()
      .replace(/\s/g, '');

    getStatusUpdates(window.firestoreDatabase, study_title, window.user_id);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
  <script type="module" src="{{ url_for('static', filename='javascript/save_page_state.js') }}"></script>

  <script type="module" src="{{ url_for('static', filename='javascript/copy_button.js') }}"></script>

  {# {% if parameters['CONFIGURE_STUDY_GCP_SETUP_MODE']['value'] == "user" and parameters['SA_EMAIL']['value'] == "" and study['type'] == "SFGWAS" %}
    <script>
      window.location.href = "{{ url_for('studies.download_sa_key_file', study_title=study['title']) }}";
    </script>
  {% endif %} #}
{% endblock %}