{% extends 'base.html' %}
{% block title %}Study{% endblock %}
{% block content %}
  <meta id="study-title-data" data-value="{{ study['title'] }}">
  <meta id="id-data" data-value="{{ g.user['id'] }}">
  <meta id="num-cpus-data" data-value="{{ request.form['NUM_CPUS'] or parameters['NUM_CPUS']['value'] }}">

  <section class="py-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-7 mx-auto">
          <div class="p-5 bg-light rounded text-center">
            <div class="mt-0 mb-3">
              <div>
                <small class="text-muted">
                  Created by
                  {{ display_names.get(study['owner'], study['owner']) }}
                  on
                  {{ study['created'].strftime('%m-%d-%Y') }}
                </small>
              </div>
              <div class="mb-3">
                <h3 class="h3 mb-0">{{ study['title'] }}</h3>
                {% include 'studies/utils/study_configuration_badge.html' %}
              </div>

              <p class="mb-1">{{ study['description'] }}</p>
              {% set owner = (g.user['id'] == study['owner']) %}
              {% include 'studies/study/study_information.html' %}
              {% include 'studies/study/study_parameters.html' %}
            </div>

            {% include 'studies/study/participants.html'%}

            <div class="mt-3" id="instructions">
              {% if study["setup_configuration"] == "website" %}
                {% if study["status"][g.user["id"]] == "" %}
                  <div>
                    <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#configure_study_modal">Configure Study</button>
                    <div class="modal fade" id="configure_study_modal" tabindex="-1">
                      <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="configure_study_modal_label">Configure your
                              {{ study_type }}
                              Study</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            {% include 'studies/study/configure_study.html' %}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mt-2">
                    <form action="{{ url_for('studies.start_protocol', study_title=study['title']) }}" method="POST">
                      <button class="mt-2 btn btn-success" type="submit" onclick="loading();">
                        <div class="loading" style="display:none">
                          <span class="spinner-grow spinner-grow-sm" role="status"></span>
                          Loading...
                        </div>
                        <div class="normal-content">
                          Begin
                          {{ study_type }}
                          Workflow
                        </div>
                      </button>
                    </form>
                  </div>
                {% else %}
                  <div>
                    <p class="text-start">
                      <b>Status of study:</b>
                    </p>
                    {% if "" in study["status"].values() %}
                      <div class="text-start alert alert-primary">waiting for others to be ready...</div>
                    {% else %}
                      <div class="status text-start alert alert-primary"></div>
                      {% if parameters["SEND_RESULTS"]["value"] == "Yes" %}
                        <div id="download-div" style="display: none">
                          <a class="text-decoration-none" href="{{url_for('studies.download_results_file', study_title=study['title'])}}">
                            Download results
                          </a>
                        </div>
                      {% elif not study['demo'] %}
                        <p class="text-muted text-start mt-2">
                          (While the protocol is running, if you want a more detailed view into what the VM is doing, you can ssh into your VM and run the command
                          <code>sudo journalctl -u google-startup-scripts.service</code>
                          to see detailed logs.)
                        </p>
                      {% endif %}
                    {% endif %}
                    <div id="check-for-update">
                      <form action="{{ url_for('studies.start_protocol', study_title=study['title']) }}" method="POST">
                        <button class="btn btn-secondary" type="submit" onclick="loading();">
                          <div class="loading" style="display:none">
                            <span class="spinner-grow spinner-grow-sm" role="status"></span>
                            Loading...
                          </div>
                          <div class="normal-content">
                            Check for update
                          </div>
                        </button>
                      </form>
                    </div>

                    <div id="manhattan-div" class="mt-2" style="display: none;">
                      <img class="w-100 h-100" id="my-image" src="/static/images/{{study['title'] | lower | replace(' ', '')}}_manhattan.png" alt="Click 'Download results' and reload page to view manhattan plot">
                      <label id="image-label" style="display: none;">Manhattan Plot</label>
                    </div>

                  </div>
                {% endif %}
              {% else %}
                <div class="text-start">

                  <p>
                    Once all participants have joined the study, and you have set the 'Study Parameters', you can proceed with the
                    <a class="text-decoration-none" href="https://sfkit.readthedocs.io/en/latest/tutorial.html#cli">sfkit Command-Line Interface (CLI)</a>
                    on your machine.
                  </p>
                  <p>
                    If you would like guidance on what size machine to use, see the
                    <a class="text-decoration-none" href=" {{url_for('general.instructions', _anchor='machine_recommendations')}} ">Machine Recommendations</a>
                    section in the instructions page.
                  </p>

                  <p>
                    Click below to download
                    <code>auth_key.txt</code>
                    which you will need on your machine to authenticate with the sfkit command-line interface.
                    <div class="text-center">
                      <a href="{{ url_for('studies.download_key_file', study_title=study['title']) }}" class="btn btn-primary btn-sm">Download Auth Key</a>
                    </div>
                  </p>

                </div>
              {% endif %}
            </div>

            {# group chat???? #}
            {# <div class="d-flex justify-content-end">
              <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample">
                Instructions
              </button>
            </div> #}

            {# <div>

              <!-- Custom CSS -->
              <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

              <input type="checkbox" id="check">
              <label class="chat-btn" for="check">
                <i class="fa fa-commenting-o comment"></i>
                <i class="fa fa-close close"></i>
              </label>
              <div class="wrapper">
                <div class="header">
                  <h6>Let's Chat - Online</h6>
                </div>
                <div class="text-center p-2">
                  <span>Please fill out the form to start chat!</span>
                </div>
                <div class="chat-form">
                  <input type="text" class="form-control" placeholder="Name">
                  <input type="text" class="form-control" placeholder="Email">
                  <textarea class="form-control" placeholder="Your Text Message"></textarea>
                  <button class="btn btn-success btn-block">Submit</button>
                </div>
              </div>

            </div> #}

          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block javascript %}
  <script>
    var study_title = document
      .getElementById("study-title-data")
      .attributes["data-value"]
      .value
      .toLowerCase()
      .replace(/\s/g, '');

    // check if the results file exists using XMLHttpRequest
  </script>

  <script>
    function loading() {
      $(".loading").show();
      $(".normal-content").hide();
    }
  </script>

  <script>
    $(document).ready(function () {
      $('#NUM_CPUS').val($('#num-cpus-data').data()['value']);
    });
  </script>

  <script type="module">
    // get the status updates from firestore
    import {getStatusUpdates} from "/static/javascript/firestore.js";

    var study_title = document
      .getElementById("study-title-data")
      .attributes["data-value"]
      .value
      .toLowerCase()
      .replace(/\s/g, '');

    getStatusUpdates(window.firestoreDatabase, study_title, window.user_id);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
  <script type="module" src="{{ url_for('static', filename='javascript/save_page_state.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='javascript/copy_button.js') }}"></script>

  {# {% if study["setup_configuration"] == "user" and parameters["AUTH_KEY"]["value"] == "" %}
    <script>
      // window.location.href = "{{ url_for('studies.download_key_file', study_title=study['title']) }}";
    </script>
  {% endif %} #}

{% endblock %}
