{% extends 'base.html' %}
{% block title %}Study Start?{% endblock %}
{% block content %}
  <meta id="study-title-data" data-value="{{ study['title'] }}">
  <meta id="id-data" data-value="{{ g.user['id'] }}">
  <meta id="num-cpus-data" data-value="{{ request.form['NUM_CPUS'] or parameters['NUM_CPUS']['value'] }}">

  <section class="py-5">
    <div class="container">
      <div class="row">
        <div class="col-lg-7 mx-auto">
          <div class="p-5 bg-light rounded text-center">
            <div class="mt-0 mb-3">
              <div>
                <small class="text-muted">
                  Created by
                  {{ display_names.get(study['owner'], study['owner']) }}
                  on
                  {{ study['created'].strftime('%m-%d-%Y') }}
                </small>
              </div>

              <div>
                <span class="h3 mb-0">{{ study['title'] }}</span>
                <span class="badge rounded-pill bg-secondary align-top" style="margin-left: -7px !important;">
                  {% if study["setup_configuration"] == "website" %}
                    auto
                  {% else %}
                    self
                  {% endif %}
                  <span type="button" data-bs-toggle="modal" data-bs-target="#{{ study['setup_configuration']}}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-question-circle" viewbox="0 0 16 16">
                      <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                      <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                    </svg>
                  </span>
                </span>
                <div class="modal fade" id="website" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="websiteLabel">Configuration - Website</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body text-start">
                        You have chosen to configure this study via the website. This means that the website will do most of the heavy-lifting to run the protocol for you. See
                        <a class="text-decoration-none" href="{{ url_for('general.instructions') }}">Instructions</a>
                        for more information.
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal fade" id="user" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="userLabel">Configuration - User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body text-start">
                        You have chosen to configure this study via the sfkit command-line interface. This means that you will run the protocol yourself via the sfkit CLI. See
                        <a class="text-decoration-none" href="{{ url_for('general.instructions') }}">Instructions</a>
                        for more information.
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <p class="mb-1">{{ study['description'] }}</p>
              {% set owner = (g.user['id'] == study['owner']) %}
              {% include 'studies/study/study_information.html' %}
              {% include 'studies/study/study_parameters.html' %}
            </div>

            {% include 'studies/study/participants.html'%}

            <div class="mt-3" id="instructions">
              {% if study["setup_configuration"] == "website" %}
                {% if study["status"][g.user["id"]] == ["not ready"] or study["status"][g.user["id"]] == [""] %}
                  <div>
                    <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#configure_study_modal">Configure Study</button>
                    <div class="modal fade" id="configure_study_modal" tabindex="-1">
                      <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="configure_study_modal_label">Configure your
                              {{ study_type }}
                              Study</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                            {% include 'studies/study/instructions.html' %}
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% include 'studies/study/begin_workflow.html' %}
                {% else %}
                  <div>
                    <p class="text-start">
                      <b>Status of study:</b>
                    </p>
                    {% if ((["not ready"] in study["status"].values())or([""] in study["status"].values())or(["invalid data"] in study["status"].values())or(["validating"] in study["status"].values())) %}
                      <p>Waiting for others to be ready...</p>
                    {% else %}
                      <div class="status text-start alert alert-info"></div>
                      <p class="text-muted text-start mt-2">
                        (While the protocol is running, if you want a more detailed view into what the VM is doing, you can ssh into your VM and run the command
                        <code>sudo journalctl -u google-startup-scripts.service</code>
                        to see detailed logs.)
                      </p>
                    {% endif %}
                    <form action="{{ url_for('studies.start_protocol', study_title=study['title']) }}" method="POST">
                      <button class="btn btn-secondary" type="submit" onclick="loading();">
                        <div class="loading" style="display:none">
                          <span class="spinner-grow spinner-grow-sm" role="status"></span>
                          Loading...
                        </div>
                        <div class="normal-content">
                          Check for update
                        </div>
                      </button>

                    </form>
                  </div>
                {% endif %}
              {% else %}
                <div class="text-start">
                  <p>
                    Your authentication key should have downloaded. This
                    <code>auth_key.txt</code>
                    will be used on your machine to authenticate with the command-line interface.
                    <small class="text-muted">(If it didn't download, you can download it by clicking the button below.)</small>
                    <div class="text-center">
                      <a href="{{ url_for('studies.download_key_file', study_title=study['title']) }}" class="btn btn-info btn-sm">Download Auth Key</a>
                    </div>
                  </p>
                  <p>
                    Once all participants have joined the study, and you have set the 'Study Parameters' according to your specifications, you can proceed with the sfkit Command-Line Interface (CLI) on your machine. For more details about the sfkit CLI, see the tutorial
                    <a class="text-decoration-none" href="https://sfkit.readthedocs.io/en/latest/tutorial.html#cli">here</a>.
                  </p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block javascript %}
  <script>
    function loading() {
      $(".loading").show();
      $(".normal-content").hide();
    }
  </script>

  <script>
    $(document).ready(function () {
      $('#NUM_CPUS').val($('#num-cpus-data').data()['value']);
    });
  </script>

  <script type="module">
    // get the status updates from firestore
    import {getStatusUpdates} from "/static/javascript/firestore.js";

    var study_title = document
      .getElementById("study-title-data")
      .attributes["data-value"]
      .value
      .toLowerCase()
      .replace(/\s/g, '');

    getStatusUpdates(window.firestoreDatabase, study_title, window.user_id);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
  <script type="module" src="{{ url_for('static', filename='javascript/save_page_state.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='javascript/copy_button.js') }}"></script>

  {% if study["setup_configuration"] == "user" and parameters["AUTH_KEY"]["value"] == "" %}
    <script>
      window.location.href = "{{ url_for('studies.download_key_file', study_title=study['title']) }}";
    </script>
  {% endif %}

{% endblock %}
