{% macro instruction_step(i, title, collapsed="collapsed", show="") -%}
  <div class="text-start">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button {{collapsed}}" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-{{i}}">
          {{i}}.
          {{title}}
        </button>
      </h2>
      <div id="collapse-{{i}}" class="{{show}} accordion-collapse collapse collapse-{{i}} collapse-{{i-1}}-{{i}} collapse-{{i}}-{{i+1}}">
        <div class="accordion-body">
          {{ caller() }}
          <p class="text-end mb-0 mt-0">
            <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-{{i-1}}-{{i}}">
              Previous
            </button>
            <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-{{i}}-{{i+1}}">
              Next
            </button>
          </p>
        </div>
      </div>
    </div>
  </div>
{%- endmacro %}

<div class="accordion" id="accordion">

  {% set i = namespace(value = 0) %}
  {% call instruction_step(i.value, "Prerequisites", collapsed = "", show = "show") %}
  <div>
    {% set i.value = i.value + 1 %}
    {% if type == GWAS %}
      <p>0. If you don't already have them, you will need to install
        <a class="text-decoration-none" href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">Git</a>
        and
        <a class="text-decoration-none" href="https://www.python.org/downloads/">Python3</a>.
      </p>
    {% endif %}
    <p>1. You should create a GCP (Google Cloud Platform) project that is dedicated to this study. If you are new to GCP, go to
      <a href="https://console.cloud.google.com/" class="text-decoration-none">console.cloud.google.com</a>
      and create an account and a project.
      <p class="px-2 mb-0">1a. You need to have the
        <code>gcloud.iam.roles.create</code>
        permission in your GCP project. If you are the owner of the project, this is automatically given.</p>
      <p class="px-2 mt-0 mb-0">If you are within an organization such that you are not the owner, please talk to your administrator to get the appropriate role.</p>
      <p class="px-2 mt-0">This could be "owner", but there are also other roles (such as "Project IAM Admin") that have this permission.</p>
      <p class="px-2">1b. You need to enable the
        <a class="text-decoration-none" href="https://cloud.google.com/compute/docs/reference/rest/v1">Compute Engine API</a>
        in your GCP account. If you don't know how to enable an API, see the Google documentation
        <a href="https://cloud.google.com/endpoints/docs/openapi/enable-api" class="text-decoration-none">here</a>
      </p>
      <p class="px-2">1c. You need to enable the
        <a class="text-decoration-none" href="https://cloud.google.com/pubsub/docs/reference/rest">PubSub API</a>
        as well.</p>
    </p>
  </div>
  {% endcall %}

  {% if type == "GWAS" %}
    {% call instruction_step(i.value, "Generate Keys") %}
    <div>
      {% set i.value = i.value + 1 %}
      <p>Open your terminal and run the following commands:</p>
      <code>git clone https://github.com/simonjmendelsohn/secure-gwas-keys-and-encryption.git</code>
      <br>
      <code>cd secure-gwas-keys-and-encryption</code>
      <br>
      <code>python3 -m venv venv && source venv/bin/activate</code>
      <br>
      <code>python -m pip install -r requirements.txt</code>
      <br>
      <code>python generate_personal_keys.py</code>
      <p class="mt-3">
        <button class="btn btn-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample">
          What are these commands doing?
        </button>
      </p>
      <div class="collapse" id="collapseExample">
        <div class="text-muted mb-2">
          <code>git clone https://github.com/simonjmendelsohn/secure-gwas-keys-and-encryption.git</code>
          copies the
          <a class="text-decoration-none" href="https://github.com/simonjmendelsohn/secure-gwas-keys-and-encryption">Secure GWAS Cryptographic Keys and Encryption</a>
          repository to your computer.
          <br><br>
          <code>cd secure-gwas-keys-and-encryption</code>
          changes the directory to the repository.
          <br><br>
          <code>python3 -m venv venv && source venv/bin/activate</code>
          creates a python virtual environment and activates it. While this is not necessary, it is good practice as it keeps all the python libraries you install here separate from the rest of your computer. For more information about python virtual environments, see
          <a class="text-decoration-none" href="https://docs.python.org/3/library/venv.html">the official documentation</a>.
          <br><br>
          <code>python -m pip install -r requirements.txt</code>
          installs all the python libraries required for the repo.
          <br><br>
          <code>python generate_personal_keys.py</code>
          generates a public key and a private key that are used for Public Key Encryption. It uses the
          <a class="text-decoration-none" href="https://pypi.org/project/PyNaCl/">PyNaCl</a>
          library, which is a python binding for the popular and well-regarded
          <a href="https://doc.libsodium.org/" class="text-decoration-none">Sodium cryptography library.</a>
        </div>
      </div>

      <form method="post" action="{{url_for('studies.upload_public_key', study_title=study['title'])}}" enctype="multipart/form-data">
        <label for="formFile" class="form-label">Please upload
          <em>my_public_key.txt</em>
          that you just generated: (Optional - if you would rather share the public key directly with the other participant, you may do so instead.)
        </label>
        <input class="form-control" type="file" name="file" id="formFile">
        <input class="mt-1" type="submit" name="upload" value="Upload">
        {% if parameters["PUBLIC_KEY"]["value"] %}
          <span class="fw-bold">Your public key has been uploaded!</span>
        {% endif %}
      </form>
    </div>
    {% endcall %}
    {% call instruction_step(i.value, "Encrypt Data") %}
    <div>
      {% set i.value = i.value + 1 %}
      <p>1. Download the other participant's public key:
        {% if public_keys[2 - role] %}
          <a class="text-decoration-none" href="{{url_for('studies.download_public_key', study_title=study['title'], role=3-role)}}">Download Public Key</a>
        {% else %}
          <strong>The other participant has not yet uploaded their key. Note: You cannot proceed without this key.</strong>
        {% endif %}
        <br>(Optional - if you would rather share the public key directly with the other participant, you may do so instead.)
      </p>
      <p class="mb-1">
        2. Go back to the secure-gwas-keys-and-encryption repo (in your terminal) and run
        <code>python encrypt_data.py</code>
        to encrypt your data. (You may have to run
        <code>source venv/bin/activate</code>
        first to reactivate your python virtual environment.)
      </p>
      <p class="mb-1">
        <button class="btn btn-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEncryptData">
          What does this command do?
        </button>
      </p>
      <div class="collapse" id="collapseEncryptData">
        <div class="text-muted px-3 mb-2">
          1. It uses your public key and the other participant's private key to generate two shared keys. These are keys accessible ONLY to you and the other participant, as they require one participant's private key and the other participant's public key to generate them. One shared key will be used to encrypt your data, and the other shared key will be used to encrypt the other participant's data.
          <br>2. It uses one of the shared keys to make a cryptographically secure pseudorandom number generator (PRNG). This PRNG generates random bytes that are subtracted from your data in order to encrypt your data.
          <br>3. It converts the newly encrypted data into a special matrix format for convenience in running the GWAS.
          <br><img class="img-fluid" src="../static/images/encryption_process.png" alt="">
        </div>
      </div>

      <div class="mt-2">
        <p>
          3. Upload the encrypted data (the encrypted_data directory) to a google cloud storage bucket in your GCP (Google Cloud Platform) project. If you are unfamiliar with Google Cloud Storage, see the google documentation
          <a class="text-decoration-none" href="https://cloud.google.com/storage/docs/quickstart-console">here</a>
          (The default configuration/settings for the bucket are fine. If you would like to choose a specific region, it is recommended that you choose us-central1 (Iowa), as the default.).
        </p>
        <p>
          4. Please set the following user-specific parameters:
          <form method="post" action="{{url_for('studies.personal_parameters', study_title=study['title'])}}">
            <div class="row mb-3 p-3 bg-light">
              <label for="GCP_PROJECT" class="col-sm-3 col-form-label text-start">
                {{parameters['GCP_PROJECT']['name']}}
              </label>
              <div class="col-sm-9">
                <input type="text" class="form-control" name="GCP_PROJECT" id="GCP_PROJECT" value="{{ request.form['GCP_PROJECT'] or parameters['GCP_PROJECT']['value'] }}">
              </div>
              <p class="mt-3 text-start text-muted">
                {{parameters['GCP_PROJECT']['description']}}
              </p>
              <label for="DATA_PATH" class="col-sm-3 col-form-label text-start">
                {{parameters['DATA_PATH']['name']}}
              </label>
              <div class="col-sm-9">
                <input type="text" class="form-control" name="DATA_PATH" id="DATA_PATH" value="{{ request.form['DATA_PATH'] or parameters['DATA_PATH']['value'] }}">
              </div>
              <p class="mt-3 text-start text-muted">
                {{parameters['DATA_PATH']['description']}}
              </p>
              <label for="NUM_INDS" class="col-sm-3 col-form-label text-start">
                {{parameters['NUM_INDS']['name']}}
              </label>
              <div class="col-sm-9">
                <input type="number" class="form-control" name="NUM_INDS" id="NUM_INDS" min="0" value="{{ request.form['NUM_INDS'] or parameters['NUM_INDS']['value'] }}">
              </div>
              <p class="mt-3 text-start text-muted">
                {{parameters['NUM_INDS']['description']}}
              </p>
              <div class="d-flex flex-wrap justify-content-center">
                <input type="submit" name="save" value="Save" class="btn btn-primary me-2 mb-2 mb-sm-0">
              </div>
            </div>
          </form>
        </p>
      </div>
    </div>
    {% endcall %}
  {% endif %}

  {% if type == "SFGWAS" %}
    {% call instruction_step(i.value, "Upload Data") %}
    <div>
      {% set i.value = i.value + 1 %}
      <p>
        3. Upload your data to a google cloud storage bucket in your GCP (Google Cloud Platform) project. If you are unfamiliar with Google Cloud Storage, see the google documentation
        <a class="text-decoration-none" href="https://cloud.google.com/storage/docs/quickstart-console">here</a>
        (The default configuration/settings for the bucket are fine. If you would like to choose a specific region, it is recommended that you choose us-central1 (Iowa), as the default.).
      </p>
      <p>
        4. Please set the following user-specific parameters:
        <form method="post" action="{{url_for('studies.personal_parameters', study_title=study['title'])}}">
          <div class="row mb-3 p-3 bg-light">
            <label for="GCP_PROJECT" class="col-sm-3 col-form-label text-start">
              {{parameters['GCP_PROJECT']['name']}}
            </label>
            <div class="col-sm-9">
              <input type="text" class="form-control" name="GCP_PROJECT" id="GCP_PROJECT" value="{{ request.form['GCP_PROJECT'] or parameters['GCP_PROJECT']['value'] }}">
            </div>
            <p class="mt-3 text-start text-muted">
              {{parameters['GCP_PROJECT']['description']}}
            </p>
            <label for="DATA_PATH" class="col-sm-3 col-form-label text-start">
              {{parameters['DATA_PATH']['name']}}
            </label>
            <div class="col-sm-9">
              <input type="text" class="form-control" name="DATA_PATH" id="DATA_PATH" value="{{ request.form['DATA_PATH'] or parameters['DATA_PATH']['value'] }}">
            </div>
            <p class="mt-3 text-start text-muted">
              {{parameters['DATA_PATH']['description']}}
            </p>
            <label for="NUM_INDS" class="col-sm-3 col-form-label text-start">
              {{parameters['NUM_INDS']['name']}}
            </label>
            <div class="col-sm-9">
              <input type="number" class="form-control" name="NUM_INDS" id="NUM_INDS" min="0" value="{{ request.form['NUM_INDS'] or parameters['NUM_INDS']['value'] }}">
            </div>
            <p class="mt-3 text-start text-muted">
              {{parameters['NUM_INDS']['description']}}
            </p>
            <div class="d-flex flex-wrap justify-content-center">
              <input type="submit" name="save" value="Save" class="btn btn-primary me-2 mb-2 mb-sm-0">
            </div>
          </div>
        </form>
      </p>
    </div>
    {% endcall %}
  {% endif %}

  {% if parameters['CONFIGURE_STUDY_GCP_SETUP_MODE']['value'] == "website" %}
    {% call instruction_step(i.value, "Give Permissions") %}
    {% set i.value = i.value + 1 %}
    {% include 'studies/study/permissions.html' %}
    {% endcall %}
    {% call instruction_step(i.value, "Validate Data") %}
    <div>
      {% set i.value = i.value + 1 %}
      <p>
        1. When you are ready, click on the
        <span class="text-success">Validate Data</span>
        button:
        {% if study['status'][g.user['id']] == [''] %}
          <p>
            <a href="{{ url_for(type.lower() + '.validate_data', study_title=study['title']) }}" class="mt-2 btn btn-success" onclick="loading();">
              <span class="normal-content">
                Validate Data
              </span>
              <span class="loading" style="display:none">
                <span class="spinner-grow spinner-grow-sm"></span>
                Loading...
              </span>
            </a>
          </p>
        {% elif study["status"][g.user["id"]] == ["validating"] %}
          <p>
            Validating Data...
            <br>
            <a href="{{ url_for('studies.study', study_title=study['title']) }}" class="btn btn-secondary">Check for update</a>
          </p>
        {% elif study["status"][g.user["id"]] == ["invalid data"] %}
          <p>
            <strong>Your data validation has failed! Please double check that you uploaded your data correctly and set the correct path in the previous step.</strong>
            <a href="{{ url_for('gwas.validate_data', study_title=study['title']) }}" class="mt-2 btn btn-success">Retry Data Validation</a>
          </p>
        {% else %}
          <p>
            <a href="{{ url_for('gwas.validate_data', study_title=study['title']) }}" class="mt-2 btn btn-success disabled">Validate Data</a>
            <strong>You have successfully validated your data!</strong>
          </p>
        {% endif %}
        This button validates that we are able to create a VM that can access your encrypted data that you uploaded in step 2.
        <br>It will also validate that your data is in the right format and approximately the correct size, insofar as we can do this on encrypted data.
      </p>
    </div>
    {% endcall %}
    {% call instruction_step(i.value, "Begin Workflow") %}
    <div>
      {% set i.value = i.value + 1 %}
      <p>
        When the validation has finished, and you are ready, click on the
        <span class="text-success">Begin
          {{ type }}
          Workflow</span>
        button. For the virtual machine configuration, the default should be fine unless you have a particularly large dataset.
      </p>
      <p>Once all participants have done so, the protocol will begin.</p>
      <p class="text-muted">(Optional) While the protocol is running, if you want a more detailed view into what the VM is doing, you can ssh into your VM and run the command
        <code>sudo journalctl -u google-startup-scripts.service</code>
        to see detailed logs.</p>
    </div>
    {% endcall %}
  {% else %}
    {% call instruction_step(i.value, "Validate Data") %}
    <div>
      {% set i.value = i.value + 1 %}
      <p>
        {% if study['status'][g.user['id']] == [''] %}
          When you are ready, return to the
          <i>secure-gwas-keys-and-encryption.git</i>, and run the
          <code>python validate_data.py</code>
          command. This step validates that we are able to create a VM that can access your encrypted data that you uploaded in step 2.
          <br>It will also validate that your data is in the right format and approximately the correct size, insofar as we can do this on encrypted data.
        {% elif study["status"][g.user["id"]] == ["validating"] %}
          <p>
            Validating Data...
            <br>
            <a href="{{ url_for('studies.study', study_title=study['title']) }}" class="btn btn-secondary">Check for update</a>
          </p>
        {% elif study["status"][g.user["id"]] == ["invalid data"] %}
          <p>
            <strong>Your data validation has failed! Please double check that you uploaded your data correctly and set the correct path in the previous step.</strong>
            <p>Once you have done that. Rerun the
              <code>python validate_data.py</code>
              command.</p>
          </p>
        {% else %}
          <p>
            <strong>You have successfully validated your data!</strong>
          </p>
        {% endif %}
      </p>
    </div>
    {% endcall %}
    {% call instruction_step(i.value, "Begin Workflow") %}
    <div>
      {% set i.value = i.value + 1 %}
      <p>
        When the validation has finished, and you are ready, enter the
        <code>python run_workflow.py</code>
        command. For the virtual machine configuration, the default should be fine unless you have a particularly large dataset.
      </p>
      <p>Once all participants have done so, the protocol will begin.</p>
      <p class="text-muted">(Optional) While the protocol is running, if you want a more detailed view into what the VM is doing, you can ssh into your VM and run the command
        <code>sudo journalctl -u google-startup-scripts.service</code>
        to see detailed logs.</p>
    </div>
    {% endcall %}
  {% endif %}
  {% call instruction_step(i.value, "Enjoy the Results") %}
  <div>
    {% set i.value = i.value + 1 %}
    <p>
      Once the protocol is complete, the study page will indicate this with a "{{ type }}
      Completed!" status.
      <br>You can then download the results (from your storage bucket in your GCP project) to share and analyze at your leisure.
    </p>
  </div>
  {% endcall %}

</div>
