{% macro instruction_step(i, title, collapsed="collapsed", show="") -%}
  <div class="text-start">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button {{collapsed}}" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-{{i}}">
          {{i}}.
          {{title}}
        </button>
      </h2>
      <div id="collapse-{{i}}" class="{{show}} accordion-collapse collapse collapse-{{i}} collapse-{{i-1}}-{{i}} collapse-{{i}}-{{i+1}}">
        <div class="accordion-body">
          {{ caller() }}
          <p class="text-end mb-0 mt-0">
            <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-{{i-1}}-{{i}}">
              Previous
            </button>
            <button class="btn btn-success" type="button" data-bs-toggle="collapse" data-bs-target=".collapse-{{i}}-{{i+1}}">
              Next
            </button>
          </p>
        </div>
      </div>
    </div>
  </div>
{%- endmacro %}

<div class="accordion" id="accordion">

  {% set i = namespace(value = 0) %}
  {% call instruction_step(i.value, "Prerequisites", collapsed = "", show = "show") %}
  <div>
    {% set i.value = i.value + 1 %}
    {% if study_type == "MPCGWAS" %}
      <p>0. If you don't already have them, you will need to install
        <a class="text-decoration-none" href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">Git</a>
        and
        <a class="text-decoration-none" href="https://www.python.org/downloads/">Python3</a>.
      </p>
    {% endif %}
    <p>1. You should create a GCP (Google Cloud Platform) project that is dedicated to this study. If you are new to GCP, go to
      <a href="https://console.cloud.google.com/" class="text-decoration-none">console.cloud.google.com</a>
      and create an account and a project.
      <p class="px-2 mb-0">1a. You need to have the
        <code>gcloud.iam.roles.create</code>
        permission in your GCP project. If you are the owner of the project, this is automatically given.</p>
      <p class="px-2 mt-0 mb-0">If you are within an organization such that you are not the owner, please talk to your administrator to get the appropriate role.</p>
      <p class="px-2 mt-0">This could be "owner", but there are also other roles (such as "Project IAM Admin") that have this permission.</p>
      <p class="px-2">1b. You need to enable the
        <a class="text-decoration-none" href="https://cloud.google.com/compute/docs/reference/rest/v1">Compute Engine API</a>
        in your GCP account. If you don't know how to enable an API, see the Google documentation
        <a href="https://cloud.google.com/endpoints/docs/openapi/enable-api" class="text-decoration-none">here</a>
      </p>
    </p>
  </div>
  {% endcall %}

  {% call instruction_step(i.value, "Upload Data") %}
  <div>
    {% set i.value = i.value + 1 %}
    <p>
      1. Upload your data to a google cloud storage bucket in your GCP (Google Cloud Platform) project. If you are unfamiliar with Google Cloud Storage, see the google documentation
      <a class="text-decoration-none" href="https://cloud.google.com/storage/docs/quickstart-console">here</a>
      (The default configuration/settings for the bucket are fine. If you would like to choose a specific region, it is recommended that you choose us-central1 (Iowa), as the default.).
    </p>
    <p>
      2. Please set the following user-specific parameters:
      <form method="post" action="{{url_for('studies.personal_parameters', study_title=study['title'])}}">
        <div class="row mb-3 p-3 bg-light">
          <label for="GCP_PROJECT" class="col-sm-3 col-form-label text-start">
            {{parameters['GCP_PROJECT']['name']}}
          </label>
          <div class="col-sm-9">
            <input type="text" class="form-control" name="GCP_PROJECT" id="GCP_PROJECT" value="{{ request.form['GCP_PROJECT'] or parameters['GCP_PROJECT']['value'] }}">
          </div>
          <p class="mt-3 text-start text-muted">
            {{parameters['GCP_PROJECT']['description']}}
          </p>
          <label for="DATA_PATH" class="col-sm-3 col-form-label text-start">
            {{parameters['DATA_PATH']['name']}}
          </label>
          <div class="col-sm-9">
            <input type="text" class="form-control" name="DATA_PATH" id="DATA_PATH" value="{{ request.form['DATA_PATH'] or parameters['DATA_PATH']['value'] }}">
          </div>
          <p class="mt-3 text-start text-muted">
            {{parameters['DATA_PATH']['description']}}
          </p>
          {% if study_type == "SFGWAS" %}
            <label for="GENO_BINARY_FILE_PREFIX" class="col-sm-3 col-form-label text-start">
              {{parameters['GENO_BINARY_FILE_PREFIX']['name']}}
            </label>
            <div class="col-sm-9">
              <input type="text" class="form-control" name="GENO_BINARY_FILE_PREFIX" id="GENO_BINARY_FILE_PREFIX" value="{{ request.form['GENO_BINARY_FILE_PREFIX'] or parameters['GENO_BINARY_FILE_PREFIX']['value'] }}">
            </div>
            <p class="mt-3 text-start text-muted">
              {{parameters['GENO_BINARY_FILE_PREFIX']['description']}}
            </p>
          {% endif %}
          {# <label for="NUM_INDS" class="col-sm-3 col-form-label text-start">
              {{parameters['NUM_INDS']['name']}}
            </label>
            <div class="col-sm-9">
              <input type="number" class="form-control" name="NUM_INDS" id="NUM_INDS" min="0" value="{{ request.form['NUM_INDS'] or parameters['NUM_INDS']['value'] }}">
            </div>
            <p class="mt-3 text-start text-muted">
              {{parameters['NUM_INDS']['description']}}
            </p> #}
          <div class="d-flex flex-wrap justify-content-center">
            <input type="submit" name="save" value="Save" class="btn btn-primary me-2 mb-2 mb-sm-0">
          </div>
        </div>
      </form>
    </p>
  </div>
  {% endcall %}

  {% call instruction_step(i.value, "Give Permissions") %}
  {% set i.value = i.value + 1 %}
  {% include 'studies/study/permissions.html' %}
  {% endcall %}

</div>
